<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>–ú–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</title>
  <style>
    :root {
      --bg: #0f172a;
      --card: #111827;
      --text: #e5e7eb;
      --muted: #94a3b8;
      --accent: #22d3ee;
      --accent-2: #8b5cf6;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at 20% 20%, #1f2937 0, #0f172a 40%),
                  radial-gradient(circle at 80% 0%, #0ea5e9 0, #0f172a 35%),
                  #0f172a;
      color: var(--text);
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 24px;
    }
    .card {
      width: min(480px, 100%);
      background: var(--card);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 25px 60px rgba(0,0,0,0.35);
      backdrop-filter: blur(6px);
    }
    h1 {
      margin: 0 0 8px;
      font-size: 26px;
      letter-spacing: -0.5px;
    }
    p { margin: 0 0 16px; color: var(--muted); line-height: 1.5; }
    .user {
      padding: 12px 14px;
      border-radius: 12px;
      background: rgba(255,255,255,0.04);
      color: var(--text);
      margin-bottom: 16px;
      font-size: 14px;
    }
    .buttons {
      display: grid;
      gap: 12px;
      margin-top: 12px;
    }
    button {
      border: 0;
      border-radius: 12px;
      padding: 14px 16px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      color: #0f172a;
      background: var(--accent);
      transition: transform 120ms ease, box-shadow 120ms ease;
      box-shadow: 0 8px 20px rgba(34, 211, 238, 0.35);
    }
    button.secondary {
      background: transparent;
      color: var(--text);
      border: 1px solid rgba(255,255,255,0.08);
      box-shadow: none;
    }
    button.ghost {
      background: rgba(255,255,255,0.06);
      color: var(--text);
      box-shadow: none;
    }
    button:active { transform: translateY(1px); }
    pre {
      background: rgba(255,255,255,0.04);
      border-radius: 12px;
      padding: 12px;
      color: var(--muted);
      font-size: 13px;
      overflow: auto;
      margin-top: 12px;
      white-space: pre-wrap;
      word-break: break-word;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>–ü—Ä–∏–≤–µ—Ç üëã</h1>
    <p>–ú–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ Telegram: –∫–æ—Ä–æ—Ç–∫–∏–π –ø—Ä–∏–≤–µ—Ç, –ø–∞—Ä–∞ –∫–Ω–æ–ø–æ–∫ –∏ –æ—Ç–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞–∑–∞–¥ –≤ –±–æ—Ç.</p>
    <div class="user" id="user-info">–ó–∞–≥—Ä—É–∂–∞—é –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...</div>
    <div class="buttons">
      <button id="hello-btn">–ü–æ–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å</button>
      <button class="secondary" id="send-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –±–æ—Ç</button>
      <button class="ghost" id="close-btn">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    <pre id="log"></pre>
  </div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    const tg = window.Telegram?.WebApp;
    const userBox = document.getElementById('user-info');
    const logBox = document.getElementById('log');

    function log(message) {
      logBox.textContent = message;
    }

    function setUserInfo() {
      const user = tg?.initDataUnsafe?.user;
      if (user) {
        const name = [user.first_name, user.last_name].filter(Boolean).join(' ');
        const username = user.username ? ` @${user.username}` : '';
        userBox.textContent = `–í—ã: ${name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}${username}`;
      } else {
        userBox.textContent = '–û—Ç–∫—Ä—ã—Ç–æ –≤–Ω–µ Telegram. –ö–Ω–æ–ø–∫–∞ "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –±–æ—Ç" –±—É–¥–µ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.';
        document.getElementById('send-btn').disabled = true;
      }
    }

    async function sendPing() {
      try {
        const user = tg?.initDataUnsafe?.user;
        const name = user?.first_name || '–¥—Ä—É–≥';
        const res = await fetch('/api/ping', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name }),
        });
        const data = await res.json();
        log(data.greeting || JSON.stringify(data));
        tg?.HapticFeedback?.impactOccurred('light');
      } catch (err) {
        log(`–û—à–∏–±–∫–∞: ${err}`);
      }
    }

    function sendToBot() {
      if (!tg) {
        log('–ù–µ—Ç Telegram WebApp –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.');
        return;
      }
      const user = tg.initDataUnsafe?.user;
      const payload = {
        source: 'webapp',
        message: '–ü—Ä–∏–≤–µ—Ç –∏–∑ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è!',
        user: user ? {
          id: user.id,
          username: user.username,
          first_name: user.first_name,
          last_name: user.last_name,
        } : null,
        timestamp: Date.now(),
      };
      tg.sendData(JSON.stringify(payload));
      log('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –±–æ—Ç. –°–º–æ—Ç—Ä–∏ —á–∞—Ç.');
      tg.HapticFeedback?.impactOccurred('soft');
    }

    function closeApp() {
      log('–ó–∞–∫—Ä—ã–≤–∞—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ...');
      tg?.close();
    }

    document.getElementById('hello-btn').addEventListener('click', sendPing);
    document.getElementById('send-btn').addEventListener('click', sendToBot);
    document.getElementById('close-btn').addEventListener('click', closeApp);

    if (tg) {
      tg.expand();
      tg.ready();
    }
    setUserInfo();
    log('–ì–æ—Ç–æ–≤–æ –∫ —Ä–∞–±–æ—Ç–µ.');
  </script>
</body>
</html>
