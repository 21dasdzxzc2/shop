<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Yarik Store</title>
  <link rel="stylesheet" href="/static/styles.css">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div class="bg-ornament"></div>
  <div class="shell">
    <div class="banned hidden" id="bannedScreen">
      <div class="banned-card">
        <div class="banned-title">ПОШЁЛ НА ХУЙ</div>
        <div class="muted">Ты забанен, хуесос</div>
      </div>
    </div>
    <header class="top">
      <div class="brand">
        <div class="dot"></div>
        <div>
          <div class="brand-title">Yarik Store</div>
          <div class="brand-sub">"Описание магаза"</div>
        </div>
      </div>
      <button class="pill ghost" id="userBadge">...</button>
    </header>

    <section class="hero">
      <div>
        <p class="eyebrow">Лучшие цены</p>
        <h1>Собери корзину и оформи заказ в пару кликов</h1>
        <p class="muted">Товары на ваш вкус, быстрое оформление и отправка, удобный интерфейс</p>
        <div class="hero-actions">
          <button class="pill accent" id="openCart">Корзина · <span id="cartCounter">0</span></button>
          <button class="pill ghost" id="clearCart">Очистить</button>
        </div>
      </div>
    </section>

    <section class="panel">
      <div class="panel-top">
        <div class="panel-title">Категории</div>
        <div class="input">
          <input id="search" type="text" placeholder="Поиск по товарам...">
        </div>
      </div>
      <div class="category-row" id="categoryRow"></div>
    </section>

    <section class="panel">
      <div class="panel-top">
        <div class="panel-title">Товары</div>
        <div class="hint" id="productCount"></div>
      </div>
      <div class="grid" id="productGrid"></div>
    </section>
  </div>

  <div class="sheet hidden" id="cartSheet">
    <div class="sheet-handle"></div>
    <div class="sheet-header">
      <div>
        <div class="sheet-title">Корзина</div>
        <div class="muted small" id="cartSubtitle">Товаров: 0</div>
      </div>
      <button class="icon-btn" id="closeSheet">✕</button>
    </div>
    <div class="cart-list" id="cartList"></div>
    <div class="checkout">
      <div>
        <div class="muted small">Итого</div>
        <div class="total" id="cartTotal">0 ₽</div>
      </div>
      <button class="pill accent" id="checkoutBtn">Оформить</button>
    </div>
    <div class="input stacked">
      <label for="contact">Контакт для связи</label>
      <input id="contact" placeholder="Телеграмм или другие контакты">
    </div>
    <div class="input stacked">
      <label for="note">Комментарий</label>
      <textarea id="note" rows="2" placeholder="Пожелания к заказу"></textarea>
    </div>
  </div>

  <div class="modal hidden" id="productModal">
    <div class="modal-backdrop" id="closeProduct"></div>
    <div class="modal-card">
      <div class="modal-image">
        <img id="modalImage" src="" alt="">
      </div>
      <div class="modal-body">
        <div class="modal-title" id="modalTitle"></div>
        <div class="muted small" id="modalDesc"></div>
        <div class="modal-price" id="modalPrice"></div>
        <div class="modal-actions">
          <button class="pill accent" id="modalAdd">В корзину</button>
          <button class="pill ghost" id="modalCloseBtn">Закрыть</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const tg = window.Telegram?.WebApp;
    const state = {
      user: tg?.initDataUnsafe?.user || null,
      categories: [],
      products: [],
      activeCategory: null,
      cartCount: 0,
      selectedProduct: null,
      banned: false,
    };

    if (tg) {
      tg.expand();
      tg.ready();
    }

    const els = {
      userBadge: document.getElementById('userBadge'),
      categoryRow: document.getElementById('categoryRow'),
      productGrid: document.getElementById('productGrid'),
      productCount: document.getElementById('productCount'),
      search: document.getElementById('search'),
      cartCounter: document.getElementById('cartCounter'),
      cartSheet: document.getElementById('cartSheet'),
      cartList: document.getElementById('cartList'),
      cartSubtitle: document.getElementById('cartSubtitle'),
      cartTotal: document.getElementById('cartTotal'),
      contact: document.getElementById('contact'),
      note: document.getElementById('note'),
    };

    function fmtPrice(num) {
      return new Intl.NumberFormat('ru-RU').format(num) + ' ₽';
    }

    function getUserId() {
      if (state.user?.id) return state.user.id;
      const params = new URLSearchParams(window.location.search);
      return parseInt(params.get('user_id') || '0', 10) || 0;
    }

    function setUserBadge() {
      if (!state.user) {
        els.userBadge.textContent = 'Гость';
        return;
      }
      const name = [state.user.first_name, state.user.last_name].filter(Boolean).join(' ');
      els.userBadge.textContent = name || state.user.username || 'Пользователь';
    }

    async function fetchJSON(url, options = {}) {
      const res = await fetch(url, {
        headers: {'Content-Type': 'application/json'},
        ...options,
      });
      return res.json();
    }

    async function checkBanned() {
      const uid = getUserId();
      if (!uid) return false;
      const res = await fetchJSON('/api/status', {
        method: 'POST',
        body: JSON.stringify({user_id: uid}),
      });
      state.banned = !!res.banned;
      if (state.banned) {
        document.getElementById('bannedScreen').classList.remove('hidden');
      } else {
        document.getElementById('bannedScreen').classList.add('hidden');
      }
      return state.banned;
    }

    async function loadCategories() {
      const data = await fetchJSON('/api/categories');
      state.categories = data.items || [];
      renderCategories();
    }

    async function loadProducts(categoryId = null) {
      let url = '/api/products';
      if (categoryId) url += `?category_id=${categoryId}`;
      const data = await fetchJSON(url);
      state.products = data.items || [];
      renderProducts();
    }

    async function refreshCart() {
      const uid = getUserId();
      if (!uid) return;
      const data = await fetchJSON(`/api/cart/${uid}`);
      state.cartCount = data.items?.reduce((acc, item) => acc + item.qty, 0) || 0;
      els.cartCounter.textContent = state.cartCount;
      els.cartSubtitle.textContent = `Товаров: ${state.cartCount}`;
      renderCart(data);
    }

    function renderCategories() {
      const row = els.categoryRow;
      row.innerHTML = '';
      const allBtn = document.createElement('button');
      allBtn.className = `chip ${state.activeCategory === null ? 'active' : ''}`;
      allBtn.textContent = 'Все';
      allBtn.onclick = () => {
        state.activeCategory = null;
        loadProducts();
        renderCategories();
      };
      row.appendChild(allBtn);

      state.categories.forEach(cat => {
        const btn = document.createElement('button');
        btn.className = `chip ${state.activeCategory === cat.id ? 'active' : ''}`;
        btn.textContent = `${cat.icon || ''} ${cat.name}`;
        btn.onclick = () => {
          state.activeCategory = cat.id;
          loadProducts(cat.id);
          renderCategories();
        };
        row.appendChild(btn);
      });
    }

    function renderProducts() {
      const grid = els.productGrid;
      grid.innerHTML = '';
      const q = els.search.value.trim().toLowerCase();
      const filtered = state.products.filter(p => p.title.toLowerCase().includes(q));
      els.productCount.textContent = `${filtered.length} позиций`;

      filtered.forEach(p => {
        const card = document.createElement('div');
        card.className = 'card product';
        card.innerHTML = `
          <div class="img"><img src="${p.thumb_url || p.image_url}" alt=""></div>
          <div class="product-title">${p.title}</div>
          <div class="muted small">${p.description || 'Описание скоро будет'}</div>
          <div class="product-footer">
            <div class="price">${fmtPrice(p.price)}</div>
            <button class="pill ghost-sm">В корзину</button>
          </div>
        `;
        card.querySelector('.img').onclick = () => openProduct(p);
        card.querySelector('.product-title').onclick = () => openProduct(p);
        card.querySelector('button').onclick = () => addToCart(p.id);
        grid.appendChild(card);
      });
    }

    async function addToCart(productId) {
      const uid = getUserId();
      if (!uid) {
        alert('Откройте через Telegram, чтобы добавить в корзину.');
        return;
      }
      if (state.banned) {
        alert('Доступ запрещён.');
        return;
      }
      await fetchJSON('/api/cart/add', {
        method: 'POST',
        body: JSON.stringify({user_id: uid, product_id: productId, qty: 1}),
      });
      if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
      await refreshCart();
    }

    function renderCart(data) {
      const list = els.cartList;
      list.innerHTML = '';
      (data.items || []).forEach(row => {
        const item = document.createElement('div');
        item.className = 'cart-row';
        item.innerHTML = `
          <div>
            <div class="cart-title">${row.product.title}</div>
            <div class="muted small">x${row.qty} · ${fmtPrice(row.product.price)} / шт</div>
          </div>
          <div class="price">${fmtPrice(row.subtotal)}</div>
        `;
        list.appendChild(item);
      });
      els.cartTotal.textContent = fmtPrice(data.total || 0);
    }

    function openCartSheet() {
      els.cartSheet.classList.remove('hidden');
      if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred('soft');
    }

    function closeCartSheet() {
      els.cartSheet.classList.add('hidden');
    }

    async function clearCart() {
      const uid = getUserId();
      if (!uid) return;
      await fetchJSON('/api/cart/clear', {
        method: 'POST',
        body: JSON.stringify({user_id: uid}),
      });
      await refreshCart();
    }

    async function checkout() {
      const uid = getUserId();
      if (!uid) return;
      if (state.banned) {
        alert('Доступ запрещён.');
        return;
      }
      if (!state.cartCount) {
        alert('Корзина пуста.');
        return;
      }
      const contact = els.contact.value.trim() || (state.user?.username ? '@' + state.user.username : '');
      const note = els.note.value.trim();
      const tg_username = state.user?.username || '';
      const tg_name = [state.user?.first_name, state.user?.last_name].filter(Boolean).join(' ');
      const res = await fetchJSON('/api/cart/checkout', {
        method: 'POST',
        body: JSON.stringify({user_id: uid, contact, note, tg_username, tg_name}),
      });
      if (tg?.showAlert) tg.showAlert(res.message || 'Заказ принят');
      if (tg?.sendData) {
        tg.sendData(JSON.stringify({action: 'checkout', user_id: uid, contact, note, tg_username, tg_name}));
      }
      await clearCart();
      closeCartSheet();
    }

    function openProduct(p) {
      state.selectedProduct = p;
      document.getElementById('modalImage').src = p.image_url;
      document.getElementById('modalTitle').textContent = p.title;
      document.getElementById('modalDesc').textContent = p.description || '';
      document.getElementById('modalPrice').textContent = fmtPrice(p.price);
      document.getElementById('productModal').classList.remove('hidden');
    }

    function closeProduct() {
      document.getElementById('productModal').classList.add('hidden');
      state.selectedProduct = null;
    }

    document.getElementById('modalAdd').onclick = () => {
      if (state.selectedProduct) addToCart(state.selectedProduct.id);
    };
    document.getElementById('modalCloseBtn').onclick = closeProduct;
    document.getElementById('closeProduct').onclick = closeProduct;

    // bindings
    els.search.oninput = renderProducts;
    document.getElementById('openCart').onclick = () => { refreshCart(); openCartSheet(); };
    document.getElementById('closeSheet').onclick = closeCartSheet;
    document.getElementById('checkoutBtn').onclick = checkout;
    document.getElementById('clearCart').onclick = clearCart;

    // init
    setUserBadge();
    checkBanned().then((isBanned) => {
      if (isBanned) return;
      loadCategories();
      loadProducts();
      refreshCart();
    });
  </script>
</body>
</html>
