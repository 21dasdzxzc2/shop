<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin ¬∑ Yarik Store</title>
  <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
  <div class="shell">
    <header class="top">
      <div class="brand">
        <div class="dot"></div>
        <div>
          <div class="brand-title">Admin ¬∑ Yarik Store</div>
          <div class="brand-sub">–ê–¥–º–∏–Ω–∫–∞ –µ–±–∞—Ç—å</div>
        </div>
      </div>
      <div class="input" style="max-width:220px;">
        <input id="token" placeholder="X-Admin-Token">
      </div>
    </header>

    <section class="panel">
      <div class="panel-top">
        <div class="panel-title">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</div>
        <button class="pill ghost" id="reloadCats">–û–±–Ω–æ–≤–∏—Ç—å</button>
      </div>
      <div class="input stacked" style="margin-top:10px;">
        <label>–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</label>
        <input id="catName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
        <input id="catIcon" placeholder="–≠–º–æ–¥–∑–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)">
        <button class="pill accent" id="createCat" style="margin-top:8px;">–°–æ–∑–¥–∞—Ç—å</button>
      </div>
      <div id="catList" style="margin-top:12px;"></div>
    </section>

    <section class="panel">
      <div class="panel-top">
        <div class="panel-title">–¢–æ–≤–∞—Ä—ã</div>
        <button class="pill ghost" id="reloadProducts">–û–±–Ω–æ–≤–∏—Ç—å</button>
      </div>
      <div class="grid" id="productList" style="margin-top:10px;"></div>
      <div class="panel" style="margin-top:12px;">
        <div class="panel-title">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</div>
        <div class="input stacked" style="margin-top:8px;">
          <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
          <input id="pTitle" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: Oversize —Ö—É–¥–∏">
        </div>
        <div class="input stacked" style="margin-top:8px;">
          <label>–¶–µ–Ω–∞</label>
          <input id="pPrice" type="number" placeholder="5990">
        </div>
        <div class="input stacked" style="margin-top:8px;">
          <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è (ID)</label>
          <input id="pCategory" type="number" placeholder="1">
        </div>
        <div class="input stacked" style="margin-top:8px;">
          <label>URL –∫–∞—Ä—Ç–∏–Ω–∫–∏</label>
          <input id="pImage" placeholder="https://postimg.cc/pyZP00kG/51269839">
        </div>
        <div class="input stacked" style="margin-top:8px;">
          <label>URL –ø—Ä–µ–≤—å—é (–º–∏–Ω–∏–∞—Ç—é—Ä–∞)</label>
          <input id="pThumb" placeholder="–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, —Å–¥–µ–ª–∞–µ—Ç—Å—è —Å–∞–º–∞ –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞—Ç—å">
        </div>
        <div class="input stacked" style="margin-top:8px;">
          <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
          <textarea id="pDesc" rows="2" placeholder="–ö—Ä–∞—Ç–∫–æ –æ —Ç–æ–≤–∞—Ä–µ"></textarea>
        </div>
        <button class="pill accent" id="createProduct" style="margin-top:10px;">–°–æ–∑–¥–∞—Ç—å —Ç–æ–≤–∞—Ä</button>
      </div>
    </section>

    <section class="panel">
      <div class="panel-top">
        <div class="panel-title">–õ–æ–≥–∏ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ)</div>
        <button class="pill ghost" id="reloadLogs">–û–±–Ω–æ–≤–∏—Ç—å</button>
      </div>
      <div id="logList" class="cart-list" style="margin-top:10px; max-height: 320px;"></div>
    </section>

    <section class="panel">
      <div class="panel-top">
        <div class="panel-title">–ë–∞–Ω—ã</div>
        <button class="pill ghost" id="reloadBans">–û–±–Ω–æ–≤–∏—Ç—å</button>
      </div>
      <div class="input stacked" style="margin-top:10px;">
        <label>–ó–∞–±–∞–Ω–∏—Ç—å user_id</label>
        <input id="banUserId" type="number" placeholder="123456">
        <input id="banReason" placeholder="–ü—Ä–∏—á–∏–Ω–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)">
        <button class="pill accent" id="addBan" style="margin-top:8px;">–ó–∞–±–∞–Ω–∏—Ç—å</button>
      </div>
      <div id="banList" class="cart-list" style="margin-top:12px; max-height: 240px;"></div>
    </section>

    <section class="panel">
      <div class="panel-top">
        <div class="panel-title">–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</div>
      </div>
      <p class="muted small">–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∞—Ä—Ö–∏–≤ data/ –≤ Telegram –∞–¥–º–∏–Ω—É (—á–µ—Ä–µ–∑ —Ç–æ–∫–µ–Ω).</p>
      <button class="pill accent" id="exportData">–í—ã–≥—Ä—É–∑–∏—Ç—å data</button>
      <div id="exportStatus" class="muted small" style="margin-top:6px;"></div>
    </section>

    <section class="panel">
      <div class="panel-top">
        <div class="panel-title">–§–∞–π–ª—ã</div>
        <button class="pill ghost" id="reloadFiles">–û–±–Ω–æ–≤–∏—Ç—å</button>
      </div>
      <div class="input stacked" style="margin-top:10px;">
        <label>–¢–µ–∫—É—â–∏–π –ø—É—Ç—å</label>
        <input id="fsPath" value="." placeholder=".">
      </div>
      <div class="file-list cart-list" id="fileList" style="max-height:320px;"></div>
      <div class="input stacked" style="margin-top:10px;">
        <label>–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª –≤ —Ç–µ–∫—É—â–∏–π –ø—É—Ç—å</label>
        <input type="file" id="uploadFile">
        <button class="pill accent" id="uploadBtn" style="margin-top:6px;">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
      </div>
    </section>
  </div>

  <script>
    const state = { token: '', categories: [] };

    function getToken() {
      const val = document.getElementById('token').value.trim();
      state.token = val;
      return val;
    }

    async function api(path, options = {}) {
      const token = getToken();
      const headers = {'Content-Type': 'application/json'};
      if (token) headers['X-Admin-Token'] = token;
      const res = await fetch(path, {...options, headers});
      if (!res.ok) {
        const txt = await res.text();
        throw new Error(`HTTP ${res.status}: ${txt}`);
      }
      return res.json();
    }

    function renderCats(data) {
      const box = document.getElementById('catList');
      box.innerHTML = '';
      (data.items || []).forEach(cat => {
        const row = document.createElement('div');
        row.className = 'cart-row';
        row.innerHTML = `
          <div style="flex:1; display:flex; flex-direction:column; gap:6px;">
            <div class="muted small">ID: ${cat.id}</div>
            <input class="cat-name" value="${cat.name}" style="width:100%; padding:6px 8px; border-radius:8px; border:1px solid var(--border); background: rgba(255,255,255,0.05); color: #fff;">
            <input class="cat-icon" value="${cat.icon || ''}" placeholder="–ò–∫–æ–Ω–∫–∞/—ç–º–æ–¥–∑–∏" style="width:100%; padding:6px 8px; border-radius:8px; border:1px solid var(--border); background: rgba(255,255,255,0.05); color: #fff;">
          </div>
          <div style="display:flex; flex-direction:column; gap:8px;">
            <button class="pill ghost-sm save-cat">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button class="pill ghost-sm delete-cat" style="color:#ef4444;">–£–¥–∞–ª–∏—Ç—å</button>
          </div>
        `;
        row.querySelector('.save-cat').onclick = () => {
          const name = row.querySelector('.cat-name').value.trim();
          const icon = row.querySelector('.cat-icon').value.trim();
          updateCat(cat.id, name, icon);
        };
        row.querySelector('.delete-cat').onclick = () => {
          if (confirm(`–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é ${cat.name}?`)) {
            deleteCat(cat.id);
          }
        };
        box.appendChild(row);
      });
      state.categories = data.items || [];
    }

    async function loadCats() {
      const data = await api('/api/categories');
      renderCats(data);
    }

    async function createCat() {
      const name = document.getElementById('catName').value.trim();
      const icon = document.getElementById('catIcon').value.trim();
      if (!name) return alert('–£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');
      await api('/api/categories', {
        method: 'POST',
        body: JSON.stringify({name, icon}),
      });
      document.getElementById('catName').value = '';
      document.getElementById('catIcon').value = '';
      loadCats();
    }

    async function updateCat(id, name, icon) {
      if (!name) return alert('–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
      await api(`/api/categories/${id}`, {
        method: 'PATCH',
        body: JSON.stringify({name, icon}),
      });
      loadCats();
    }

    async function deleteCat(id) {
      await api(`/api/categories/${id}`, {method: 'DELETE'});
      loadCats();
    }

    function renderProducts(data) {
      const grid = document.getElementById('productList');
      grid.innerHTML = '';
      (data.items || []).forEach(p => {
        const card = document.createElement('div');
        card.className = 'card product';
        card.innerHTML = `
          <div class="img"><img src="${p.image_url}" alt=""></div>
          <div class="product-title">${p.title}</div>
          <div class="muted small">ID: ${p.id} ¬∑ –ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${p.category_id}</div>
          <div class="product-footer"><div class="price">${p.price} ‚ÇΩ</div></div>
        `;
        grid.appendChild(card);
      });
    }

    async function loadProducts() {
      const data = await api('/api/products');
      renderProducts(data);
    }

    async function createProduct() {
      const title = document.getElementById('pTitle').value.trim();
      const price = parseFloat(document.getElementById('pPrice').value);
      const category_id = parseInt(document.getElementById('pCategory').value, 10);
      const image_url = document.getElementById('pImage').value.trim() || '/static/img/placeholder.svg';
      const thumb_url = document.getElementById('pThumb').value.trim();
      const description = document.getElementById('pDesc').value.trim();
      if (!title || !price || !category_id) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ, —Ü–µ–Ω—É –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é');
      await api('/api/products', {
        method: 'POST',
        body: JSON.stringify({title, price, category_id, image_url, thumb_url, description}),
      });
      document.getElementById('pTitle').value = '';
      document.getElementById('pPrice').value = '';
      document.getElementById('pCategory').value = '';
      document.getElementById('pImage').value = '';
      document.getElementById('pThumb').value = '';
      document.getElementById('pDesc').value = '';
      loadProducts();
    }

    async function loadLogs() {
      const data = await api('/api/admin/logs');
      const box = document.getElementById('logList');
      box.innerHTML = '';
      (data.items || []).slice().reverse().forEach(log => {
        const row = document.createElement('div');
        row.className = 'cart-row';
        row.innerHTML = `
          <div>
            <div class="cart-title">${log.kind}</div>
            <div class="muted small">${log.ts}</div>
          </div>
          <div class="muted small">user: ${log.user_id ?? '-'}</div>
        `;
        box.appendChild(row);
      });
    }

    async function loadBans() {
      const data = await api('/api/admin/bans');
      const box = document.getElementById('banList');
      box.innerHTML = '';
      (data.items || []).forEach(ban => {
        const row = document.createElement('div');
        row.className = 'cart-row';
        row.innerHTML = `
          <div>
            <div class="cart-title">user_id: ${ban.user_id}</div>
            <div class="muted small">${ban.reason || ''}</div>
          </div>
          <button class="pill ghost-sm unban">–†–∞–∑–±–∞–Ω–∏—Ç—å</button>
        `;
        row.querySelector('.unban').onclick = () => unban(ban.user_id);
        box.appendChild(row);
      });
    }

    async function addBan() {
      const user_id = parseInt(document.getElementById('banUserId').value, 10);
      const reason = document.getElementById('banReason').value.trim();
      if (!user_id) return alert('–£–∫–∞–∂–∏—Ç–µ user_id');
      await api('/api/admin/bans', {
        method: 'POST',
        body: JSON.stringify({user_id, reason}),
      });
      document.getElementById('banUserId').value = '';
      document.getElementById('banReason').value = '';
      loadBans();
    }

    async function unban(user_id) {
      await api(`/api/admin/bans/${user_id}`, {method: 'DELETE'});
      loadBans();
    }

    async function exportData() {
      const statusEl = document.getElementById('exportStatus');
      statusEl.textContent = '–ì–æ—Ç–æ–≤–ª—é –∞—Ä—Ö–∏–≤...';
      try {
        const res = await api('/api/admin/export', {method: 'POST'});
        if (res.ok) {
          statusEl.textContent = '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∞–¥–º–∏–Ω—É –≤ Telegram.';
        } else {
          statusEl.textContent = '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏.';
        }
      } catch (e) {
        statusEl.textContent = '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏.';
      }
    }

    function fsApi(path, opts = {}) {
      const token = getToken();
      const headers = opts.headers || {};
      if (token) headers['X-Admin-Token'] = token;
      return fetch(path, {...opts, headers});
    }

    async function loadFiles(path = null) {
      const p = path ?? document.getElementById('fsPath').value.trim() || '.';
      document.getElementById('fsPath').value = p;
      const token = getToken();
      const res = await fetch(`/api/admin/files?path=${encodeURIComponent(p)}`, {
        headers: token ? {'X-Admin-Token': token} : {},
      });
      if (!res.ok) {
        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤');
        return;
      }
      const data = await res.json();
      renderFiles(data.items || [], data.cwd || p);
    }

    function renderFiles(items, cwd) {
      const box = document.getElementById('fileList');
      box.innerHTML = '';
      const upBtn = document.createElement('button');
      upBtn.className = 'pill ghost-sm';
      upBtn.textContent = '‚üµ –í–≤–µ—Ä—Ö';
      upBtn.onclick = () => {
        const parts = cwd.split('/').filter(Boolean);
        parts.pop();
        const newPath = parts.join('/') || '.';
        loadFiles(newPath);
      };
      const upWrap = document.createElement('div');
      upWrap.className = 'cart-row';
      upWrap.appendChild(upBtn);
      box.appendChild(upWrap);

      items.forEach(item => {
        const row = document.createElement('div');
        row.className = 'cart-row';
        row.innerHTML = `
          <div>
            <div class="cart-title">${item.is_dir ? 'üìÅ' : 'üìÑ'} ${item.name}</div>
            <div class="muted small">${item.is_dir ? '–ø–∞–ø–∫–∞' : (item.size || 0) + ' –±–∞–π—Ç'}</div>
          </div>
          <div style="display:flex; gap:6px; align-items:center;">
            <button class="pill ghost-sm open-file">–û—Ç–∫—Ä—ã—Ç—å</button>
            ${item.is_dir ? '' : `<button class="pill ghost-sm download">–°–∫–∞—á–∞—Ç—å</button>`}
            <button class="pill ghost-sm rename">–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å</button>
            <button class="pill ghost-sm" style="color:#ef4444;">–£–¥–∞–ª–∏—Ç—å</button>
          </div>
        `;
        row.querySelector('.open-file').onclick = () => {
          if (item.is_dir) {
            loadFiles(item.path);
          } else {
            const token = getToken();
            const url = `/api/admin/files/download?path=${encodeURIComponent(item.path)}${token ? `&token=${encodeURIComponent(token)}` : ''}`;
            window.open(url, '_blank');
          }
        };
        if (!item.is_dir) {
          row.querySelector('.download').onclick = () => {
            const token = getToken();
            const url = `/api/admin/files/download?path=${encodeURIComponent(item.path)}${token ? `&token=${encodeURIComponent(token)}` : ''}`;
            window.open(url, '_blank');
          };
        }
        row.querySelector('.rename').onclick = async () => {
          const newName = prompt('–ù–æ–≤–æ–µ –∏–º—è', item.name);
          if (!newName) return;
          const newPath = (item.path.split('/').slice(0, -1).filter(Boolean).join('/') + '/' + newName).replace('//','/');
          await api('/api/admin/files/rename', {
            method: 'POST',
            body: JSON.stringify({src: item.path, dst: newPath}),
          });
          loadFiles(cwd);
        };
        row.querySelector('button[style*="ef4444"]').onclick = async () => {
          if (!confirm(`–£–¥–∞–ª–∏—Ç—å ${item.name}?`)) return;
          await api('/api/admin/files/delete', {
            method: 'POST',
            body: JSON.stringify({path: item.path}),
          });
          loadFiles(cwd);
        };
        box.appendChild(row);
      });
    }

    async function uploadFile() {
      const fileInput = document.getElementById('uploadFile');
      if (!fileInput.files.length) return alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª');
      const path = document.getElementById('fsPath').value.trim() || '.';
      const token = getToken();
      const fd = new FormData();
      fd.append('path', path);
      fd.append('file', fileInput.files[0]);
      const res = await fetch('/api/admin/files/upload', {
        method: 'POST',
        headers: token ? {'X-Admin-Token': token} : {},
        body: fd,
      });
      if (!res.ok) {
        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
        return;
      }
      loadFiles(path);
      fileInput.value = '';
    }

    document.getElementById('reloadCats').onclick = loadCats;
    document.getElementById('createCat').onclick = createCat;
    document.getElementById('reloadProducts').onclick = loadProducts;
    document.getElementById('createProduct').onclick = createProduct;
    document.getElementById('reloadLogs').onclick = loadLogs;
    document.getElementById('reloadBans').onclick = loadBans;
    document.getElementById('addBan').onclick = addBan;
    document.getElementById('exportData').onclick = exportData;
    document.getElementById('reloadFiles').onclick = () => loadFiles();
    document.getElementById('uploadBtn').onclick = uploadFile;

    loadCats();
    loadProducts();
    loadLogs();
    loadBans();
    loadFiles();
  </script>
</body>
</html>
